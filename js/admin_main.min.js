function e(e){const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}function t(e){return e?e.replace(/</g,"&lt;").replace(/>/g,"&gt;"):""}async function n(e){const n={id:`id-${Date.now()}`,timestamp:(new Date).toISOString(),nome:t(e.nome),mensagem:t(e.mensagem)};try{const e=await fetch(window.AppConfig.api.url,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(n)});if(e.ok){if((await e.json()).created>=1)return{success:!0}}return{success:!1,message:"Não foi possível enviar sua confirmação. Tente novamente."}}catch(e){return{success:!1,message:"Erro de conexão. Verifique sua internet e tente novamente."}}}async function a(){try{const e=await fetch(window.AppConfig.api.url);return e.ok?await e.json():[]}catch(e){return[]}}async function s(e){const t=`${window.AppConfig.api.url}/id/${e}`;try{const e=await fetch(t,{method:"DELETE"});return e.ok,await e.json()}catch(e){}}async function i(){return{confirmed:(await a()).length}}async function o(){const e=await a();if(0===e.length)return void alert("Nenhuma confirmação para exportar.");l("ID,Nome,Mensagem,Data da Confirmação\n"+e.map(e=>[e.id,`"${(e.nome||"").replace(/"/g,'""')}"`,`"${(e.mensagem||"").replace(/"/g,'""')}"`,new Date(e.timestamp).toLocaleString("pt-BR")].join(",")).join("\n"),"confirmacoes_festa.csv","text/csv")}async function r(){const e=await a();if(0===e.length)return void alert("Nenhuma confirmação para exportar.");l(JSON.stringify(e,null,2),"confirmacoes_festa.json","application/json")}function l(e,t,n){const a=new Blob([e],{type:n}),s=URL.createObjectURL(a),i=document.createElement("a");i.href=s,i.setAttribute("download",t),document.body.appendChild(i),i.click(),document.body.removeChild(i)}document.addEventListener("DOMContentLoaded",()=>{({elements:{loginSection:document.getElementById("login-section"),dashboardSection:document.getElementById("dashboard-section"),loginForm:document.getElementById("login-form"),loginError:document.getElementById("login-error"),logoutBtn:document.getElementById("logout-btn"),cardConfirmed:document.getElementById("card-confirmed"),tableBody:document.getElementById("rsvps-table-body"),searchInput:document.getElementById("search-input"),paginationControls:document.getElementById("pagination-controls"),barChartCanvas:document.getElementById("bar-chart"),exportCsvBtn:document.getElementById("export-csv-btn"),exportJsonBtn:document.getElementById("export-json-btn"),clearAllBtn:document.getElementById("clear-all-btn")},state:{allRsvps:[],filteredRsvps:[],currentPage:1,rowsPerPage:5,hoveredBarIndex:null,barRects:[]},init(){this.checkAuth(),this.addEventListeners()},checkAuth(){"true"===sessionStorage.getItem("isLoggedIn")?this.showDashboard():this.showLogin()},handleLogin(e){e.preventDefault();const t=this.elements.loginForm.querySelector("#username").value,n=this.elements.loginForm.querySelector("#password").value;t===window.AppConfig.admin.user&&n===window.AppConfig.admin.pass?(sessionStorage.setItem("isLoggedIn","true"),this.showDashboard()):this.elements.loginError.textContent="Usuário ou senha inválidos."},handleLogout(){sessionStorage.removeItem("isLoggedIn"),this.showLogin()},showLogin(){this.elements.loginSection.hidden=!1,this.elements.dashboardSection.hidden=!0},async showDashboard(){this.elements.loginSection.hidden=!0,this.elements.dashboardSection.hidden=!1,await this.loadAndRenderData()},async loadAndRenderData(){const e=await a();this.state.allRsvps=e.sort((e,t)=>new Date(t.timestamp)-new Date(e.timestamp)),this.filterData(),this.renderAllComponents()},filterData(){const e=this.elements.searchInput.value.toLowerCase();this.state.filteredRsvps=e?this.state.allRsvps.filter(t=>t.nome.toLowerCase().includes(e)):this.state.allRsvps,this.state.currentPage=1},renderAllComponents(){this.renderCards(),this.renderTable(),this.renderCharts()},async renderCards(){const e=await i();this.elements.cardConfirmed.textContent=e.confirmed},renderTable(){this.elements.tableBody.innerHTML="";const e=(this.state.currentPage-1)*this.state.rowsPerPage,t=e+this.state.rowsPerPage,n=this.state.filteredRsvps.slice(e,t);0===n.length?this.elements.tableBody.innerHTML='<tr<td colspan="4" style="text-align:center;">Nenhuma confirmação encontrada.</td></tr>':n.forEach(e=>{const t=document.createElement("tr");t.innerHTML=`<td>${e.nome}</td><td>${e.mensagem||"---"}</td><td>${new Date(e.timestamp).toLocaleDateString("pt-BR")}</td><td><button class="btn btn-danger delete-btn" data-id="${e.id}">Remover</button></td>`,this.elements.tableBody.appendChild(t)}),this.renderPagination()},renderPagination(){this.elements.paginationControls.innerHTML="";const e=Math.ceil(this.state.filteredRsvps.length/this.state.rowsPerPage);if(!(e<=1))for(let t=1;t<=e;t++){const e=document.createElement("button");e.className="btn btn-secondary",e.textContent=t,t===this.state.currentPage&&(e.disabled=!0),e.addEventListener("click",()=>{this.state.currentPage=t,this.renderTable()}),this.elements.paginationControls.appendChild(e)}},renderCharts(){this.animateChart(this.drawBarChart.bind(this))},animateChart(e){let t=null;const n=a=>{t||(t=a);const s=Math.min((a-t)/1e3,1);e(s),s<1&&window.requestAnimationFrame(n)};window.requestAnimationFrame(n)},drawBarChart(t=1){const n=this.elements.barChartCanvas.getContext("2d"),a=this.state.allRsvps.reduce((t,n)=>{const a=e(n.timestamp);return t[a]=(t[a]||0)+1,t},{}),s=Object.keys(a).sort(),i=s.map(e=>a[e]);if(n.clearRect(0,0,n.canvas.width,n.canvas.height),0===s.length)return;const o=Math.max(...i),r=n.canvas.width/(2*s.length);if(this.state.barRects=[],i.forEach((e,a)=>{const i=e/o*.8*n.canvas.height*t,l=2*a*r+r/2,d=n.canvas.height-i-20;this.state.barRects[a]={x:l,y:d,width:r,height:i,label:s[a],value:e},n.fillStyle=this.state.hoveredBarIndex===a?"#F8D800":"rgba(69, 182, 254, 0.8)",n.fillRect(l,d,r,i),n.fillStyle="white",n.textAlign="center",n.fillText(s[a].substring(5).replace("-","/"),l+r/2,n.canvas.height-5)}),null!==this.state.hoveredBarIndex){const e=this.state.barRects[this.state.hoveredBarIndex],t=new Date(`${e.label}T00:00:00`),a=`${e.value} em ${t.toLocaleDateString("pt-BR")}`;n.font="12px Montserrat",n.textAlign="left";const s=n.measureText(a).width+10;n.fillStyle="rgba(0, 0, 0, 0.7)",n.fillRect(e.x,e.y-25,s,20),n.fillStyle="white",n.fillText(a,e.x+5,e.y-12)}},addEventListeners(){this.elements.loginForm.addEventListener("submit",this.handleLogin.bind(this)),this.elements.logoutBtn.addEventListener("click",this.handleLogout.bind(this)),this.elements.searchInput.addEventListener("input",()=>{this.filterData(),this.renderTable()}),this.elements.tableBody.addEventListener("click",async e=>{if(e.target.classList.contains("delete-btn")){const t=e.target.dataset.id;confirm("Tem certeza que deseja remover esta confirmação?")&&(await s(t),await this.loadAndRenderData())}}),this.elements.exportCsvBtn.addEventListener("click",o),this.elements.exportJsonBtn.addEventListener("click",r),this.elements.clearAllBtn.addEventListener("click",()=>{alert("Para limpar todos os dados, por favor, apague as linhas diretamente na sua planilha do Google Sheets.")}),this.elements.barChartCanvas.addEventListener("mousemove",e=>{const t=this.elements.barChartCanvas.getBoundingClientRect(),n=e.clientX-t.left,a=e.clientY-t.top;let s=null;this.state.barRects&&this.state.barRects.forEach((e,t)=>{n>=e.x&&n<=e.x+e.width&&a>=e.y&&a<=e.y+e.height&&(s=t)}),this.state.hoveredBarIndex!==s&&(this.state.hoveredBarIndex=s,this.drawBarChart())})}}).init()});