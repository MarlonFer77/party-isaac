function e(e){return e?e.replace(/</g,"&lt;").replace(/>/g,"&gt;"):""}async function t(t){const n={id:`id-${Date.now()}`,timestamp:(new Date).toISOString(),nome:e(t.nome),acompanhantes:parseInt(t.acompanhantes)||0,mensagem:e(t.mensagem)};try{const e=await fetch(window.AppConfig.api.url,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(n)});if(e.ok){if((await e.json()).created>=1)return{success:!0}}return{success:!1,message:"Não foi possível enviar sua confirmação. Tente novamente."}}catch(e){return{success:!1,message:"Erro de conexão. Verifique sua internet e tente novamente."}}}async function n(){try{const e=await fetch(window.AppConfig.api.url);return e.ok?await e.json():[]}catch(e){return[]}}async function o(e){const t=`${window.AppConfig.api.url}/id/${e}`;try{const e=await fetch(t,{method:"DELETE"});return e.ok,await e.json()}catch(e){}}async function s(){const e=await n(),t=e.length,o=e.reduce((e,t)=>e+parseInt(t.acompanhantes||0),0);return{confirmed:t,guests:o,total:t+o}}async function a(){const e=await n();if(0===e.length)return void alert("Nenhuma confirmação para exportar.");l("ID,Nome,Acompanhantes,Mensagem,Data da Confirmação\n"+e.map(e=>[e.id,`"${(e.nome||"").replace(/"/g,'""')}"`,e.acompanhantes,`"${(e.mensagem||"").replace(/"/g,'""')}"`,new Date(e.timestamp).toLocaleString("pt-BR")].join(",")).join("\n"),"text/csv","confirmacoes_festa.csv")}async function i(){const e=await n();if(0===e.length)return void alert("Nenhuma confirmação para exportar.");l(JSON.stringify(e,null,2),"application/json","confirmacoes_festa.json")}function l(e,t,n){const o=new Blob([e],{type:t}),s=URL.createObjectURL(o),a=document.createElement("a");a.href=s,a.setAttribute("download",n),document.body.appendChild(a),a.click(),document.body.removeChild(a)}document.addEventListener("DOMContentLoaded",()=>{({elements:{rsvpSection:document.getElementById("rsvp"),rsvpForm:document.getElementById("rsvp-form"),heroTitle:document.querySelector(".hero-title"),heroDate:document.querySelector(".hero-date"),countdownUnits:{days:document.getElementById("days"),hours:document.getElementById("hours"),minutes:document.getElementById("minutes"),seconds:document.getElementById("seconds")},carouselTrack:document.querySelector(".carousel-track"),carouselPagination:document.querySelector(".carousel-pagination"),prevButton:document.querySelector(".carousel-button.prev"),nextButton:document.querySelector(".carousel-button.next"),info:{localNome:document.getElementById("local-nome"),localEndereco:document.getElementById("local-endereco"),localLink:document.getElementById("local-link"),dressCode:document.getElementById("dress-code"),observacoes:document.getElementById("observacoes")},accompanistsSelect:document.getElementById("accompanists"),thankYouModal:document.getElementById("thank-you-modal"),modalBody:document.getElementById("modal-body"),closeModalButton:document.querySelector(".modal-close"),addToCalendarButton:document.getElementById("add-to-calendar"),easterEgg:document.getElementById("easter-egg"),bubbleSound:document.getElementById("bubble-sound"),ctaScrolls:document.querySelectorAll(".cta-scroll"),contactLink:document.getElementById("contact-link"),rsvpSubmitButton:document.querySelector("#rsvp-form .btn-submit")},state:{lastSubmissionTimestamp:0,countdownInterval:null,currentSlide:0,carouselAutoplay:null,elementToFocusOnModalClose:null},init(){this.checkInviteKey(),this.populateData(),this.startCountdown(),this.setupCarousel(),this.setupRsvpForm(),this.setupContactButton(),this.setupModal(),this.setupMicrointeractions(),this.setupScrollLinks()},checkInviteKey(){const{chaveSecreta:e}=window.AppConfig.rsvp,t=document.querySelector('a.cta-scroll[href="#rsvp"]');if(!e)return void(this.elements.rsvpSection.hidden=!1);new URLSearchParams(window.location.search).get("k")===e?this.elements.rsvpSection.hidden=!1:t&&(t.classList.add("disabled"),t.title="Use o link de convite que você recebeu para confirmar a presença.")},populateData(){const{aniversariante:e,evento:t}=window.AppConfig;this.elements.heroTitle.textContent=e.nome,this.elements.heroDate.textContent=t.data,this.elements.info.localNome.textContent=t.local.nome,this.elements.info.localEndereco.textContent=t.local.endereco,this.elements.info.localLink.href=t.local.googleMapsLink,this.elements.info.dressCode.textContent=t.dressCode,this.elements.info.observacoes.textContent=t.observacoes;for(let e=0;e<=window.AppConfig.rsvp.maxAcompanhantes;e++){const t=document.createElement("option");t.value=e,t.textContent=e,this.elements.accompanistsSelect.appendChild(t)}},startCountdown(){const e=new Date(window.AppConfig.evento.dataISO).getTime();this.state.countdownInterval=setInterval(()=>{const t=(new Date).getTime(),n=e-t;if(n<0)return clearInterval(this.state.countdownInterval),void(document.getElementById("countdown-section").innerHTML='<h3 class="section-title">A festa já aconteceu!</h3>');const o=Math.floor(n/864e5),s=Math.floor(n%864e5/36e5),a=Math.floor(n%36e5/6e4),i=Math.floor(n%6e4/1e3);this.elements.countdownUnits.days.textContent=String(o).padStart(2,"0"),this.elements.countdownUnits.hours.textContent=String(s).padStart(2,"0"),this.elements.countdownUnits.minutes.textContent=String(a).padStart(2,"0"),this.elements.countdownUnits.seconds.textContent=String(i).padStart(2,"0")},1e3)},setupCarousel(){const{fotos:e,videos:t}=window.AppConfig.media,n=[...e,...t];0!==n.length&&(n.forEach((e,t)=>{const n=document.createElement("div");if(n.className="carousel-slide",e.endsWith(".mp4"))n.innerHTML=`<video src="public/assets/video/${e}" preload="metadata" controls loading="lazy"></video>`;else{const o=e.substring(0,e.lastIndexOf(".")),s=e.substring(e.lastIndexOf(".")+1);n.innerHTML=`\n                  <img src="public/assets/img/${e}" \n                       srcset="public/assets/img/${o}-600w.${s} 600w, \n                               public/assets/img/${o}-1200w.${s} 1200w"\n                       sizes="(max-width: 800px) 90vw, 800px"\n                       alt="Foto ${t+1} do ensaio" loading="lazy">\n              `}this.elements.carouselTrack.appendChild(n);const o=document.createElement("button");o.className="pagination-dot",o.dataset.slide=t,o.setAttribute("aria-label",`Ir para slide ${t+1}`),this.elements.carouselPagination.appendChild(o)}),this.updateCarousel(),this.elements.nextButton.addEventListener("click",()=>this.moveSlide(1)),this.elements.prevButton.addEventListener("click",()=>this.moveSlide(-1)),this.elements.carouselPagination.addEventListener("click",e=>{e.target.matches(".pagination-dot")&&(this.state.currentSlide=parseInt(e.target.dataset.slide),this.updateCarousel())}),this.startCarouselAutoplay(),this.elements.carouselTrack.parentElement.addEventListener("mouseenter",()=>clearInterval(this.state.carouselAutoplay)),this.elements.carouselTrack.parentElement.addEventListener("mouseleave",()=>this.startCarouselAutoplay()))},moveSlide(e){const t=this.elements.carouselTrack.children.length;this.state.currentSlide=(this.state.currentSlide+e+t)%t,this.updateCarousel()},updateCarousel(){const e=-100*this.state.currentSlide;this.elements.carouselTrack.style.transform=`translateX(${e}%)`,document.querySelectorAll(".pagination-dot").forEach((e,t)=>e.classList.toggle("active",t===this.state.currentSlide))},startCarouselAutoplay(){clearInterval(this.state.carouselAutoplay),this.state.carouselAutoplay=setInterval(()=>this.moveSlide(1),5e3)},setupRsvpForm(){this.elements.rsvpSection.hidden||(this.elements.rsvpForm.addEventListener("submit",async e=>{e.preventDefault();const n=Date.now();if(n-this.state.lastSubmissionTimestamp<1e4)alert("Por favor, aguarde um momento antes de tentar enviar novamente.");else if(this.validateForm()){const e=new FormData(this.elements.rsvpForm),o={nome:e.get("name"),acompanhantes:parseInt(e.get("accompanists")),mensagem:e.get("message")},s=await t(o);s.success?(this.state.lastSubmissionTimestamp=n,this.state.elementToFocusOnModalClose=document.activeElement,this.showThankYouModal(o.nome,o.acompanhantes),this.elements.rsvpForm.reset()):alert(s.message||"Ocorreu um erro ao salvar sua confirmação.")}}),this.elements.rsvpSubmitButton.addEventListener("click",()=>{this.elements.bubbleSound&&(this.elements.bubbleSound.currentTime=0,this.elements.bubbleSound.play())}))},validateForm(){let e=!0;const t=this.elements.rsvpForm.querySelector("#name"),n=t.nextElementSibling;return""===t.value.trim()?(t.classList.add("invalid"),n.textContent="Por favor, preencha seu nome.",e=!1):(t.classList.remove("invalid"),n.textContent=""),e},showThankYouModal(e,t){let n=`Sua presença foi confirmada, ${e}!`;if(t>0){n+=` Esperamos por você e seu(s) ${t} ${t>1?"acompanhantes":"acompanhante"}.`}this.elements.modalBody.textContent=n,this.elements.thankYouModal.hidden=!1,this.elements.thankYouModal.setAttribute("aria-hidden","false"),this.elements.closeModalButton.focus()},setupModal(){const e=()=>{this.elements.thankYouModal.hidden=!0,this.elements.thankYouModal.setAttribute("aria-hidden","true"),this.state.elementToFocusOnModalClose&&this.state.elementToFocusOnModalClose.focus()};this.elements.closeModalButton.addEventListener("click",e),this.elements.thankYouModal.addEventListener("click",t=>{t.target===this.elements.thankYouModal&&e()}),document.addEventListener("keydown",t=>{"Escape"!==t.key||this.elements.thankYouModal.hidden||e()}),this.elements.addToCalendarButton.addEventListener("click",()=>this.generateIcsFile())},generateIcsFile(){const{evento:e,aniversariante:t}=window.AppConfig,n=new Date(e.dataISO),o=new Date(n.getTime()+144e5),s=e=>e.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z",a=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//FestaDoIsaac//NONSGML v1.0//EN","BEGIN:VEVENT",`UID:${Date.now()}@festadoisaac.com`,`DTSTAMP:${s(new Date)}`,`DTSTART:${s(n)}`,`DTEND:${s(o)}`,`SUMMARY:Festa de 1 Aninho do ${t.nome}`,`DESCRIPTION:Vamos celebrar o primeiro aninho do ${t.nome}! ${e.observacoes}`,`LOCATION:${e.local.nome}, ${e.local.endereco}`,"END:VEVENT","END:CALENDAR"].join("\r\n"),i=new Blob([a],{type:"text/calendar;charset=utf-8"}),l=URL.createObjectURL(i),c=document.createElement("a");c.href=l,c.setAttribute("download",`festa-${t.nome.toLowerCase()}.ics`),document.body.appendChild(c),c.click(),document.body.removeChild(c)},setupMicrointeractions(){document.querySelectorAll(".btn").forEach(e=>e.addEventListener("click",this.createRipple)),document.body.addEventListener("click",e=>{e.target.closest("a, button, input, select, textarea")||this.createClickBubbles(e.clientX,e.clientY)}),this.elements.easterEgg.addEventListener("click",()=>{this.elements.bubbleSound.currentTime=0,this.elements.bubbleSound.play(),this.createClickBubbles(this.elements.easterEgg.getBoundingClientRect().left,this.elements.easterEgg.getBoundingClientRect().top)})},createRipple(e){const t=e.currentTarget,n=document.createElement("span"),o=Math.max(t.clientWidth,t.clientHeight);n.style.width=n.style.height=`${o}px`,n.style.left=e.clientX-t.getBoundingClientRect().left-o/2+"px",n.style.top=e.clientY-t.getBoundingClientRect().top-o/2+"px",n.classList.add("ripple");const s=t.querySelector(".ripple");s&&s.remove(),t.appendChild(n)},setupContactButton(){const{contato:e}=window.AppConfig;if(e&&e.numero)if("whatsapp"===e.tipo){const t=encodeURIComponent(e.mensagemPadrao),n=`https://wa.me/${e.numero}?text=${t}`;this.elements.contactLink.href=n,this.elements.contactLink.textContent="Fale conosco via WhatsApp"}else"telefone"===e.tipo&&(this.elements.contactLink.href=`tel:${e.numero}`,this.elements.contactLink.textContent="Ligue para nós");else this.elements.contactLink.parentElement.hidden=!0},createClickBubbles(e,t){const n=document.querySelector(".bubbles-container");for(let o=0;o<5;o++){const o=document.createElement("div");o.className="bubble";const s=20*Math.random()+10;o.style.width=`${s}px`,o.style.height=`${s}px`,o.style.left=`${e+(40*Math.random()-20)}px`,o.style.top=`${t+(40*Math.random()-20)}px`,o.style.animationDuration=2*Math.random()+1+"s",o.style.animationDelay=.2*Math.random()+"s",o.addEventListener("animationend",()=>o.remove()),n.appendChild(o)}},setupScrollLinks(){this.elements.ctaScrolls.forEach(e=>{e.addEventListener("click",t=>{if(e.classList.contains("disabled"))return void t.preventDefault();t.preventDefault();const n=e.getAttribute("href");document.querySelector(n).scrollIntoView({behavior:"smooth"})})})}}).init()});